<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js ayu">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>GroupBy - Polars - User Guide</title>
        
        


        <!-- Custom HTML head -->
        


        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        
        <link rel="icon" href="../favicon.svg">
        
        
        <link rel="shortcut icon" href="../favicon.png">
        
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        
        <link rel="stylesheet" href="../css/print.css" media="print">
        

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        
        <link rel="stylesheet" href="../fonts/fonts.css">
        

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
        <link rel="stylesheet" href="../tabbed-code-blocks.css">
        

        
        <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "ayu";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('ayu')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../quickstart/intro.html"><strong aria-hidden="true">2.</strong> Getting started</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../quickstart/quick-exploration-guide.html"><strong aria-hidden="true">2.1.</strong> Polars quick exploration guide</a></li></ol></li><li class="chapter-item expanded "><a href="../dsl/intro.html"><strong aria-hidden="true">3.</strong> Polars expressions</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../dsl/expressions.html"><strong aria-hidden="true">3.1.</strong> Expressions</a></li><li class="chapter-item "><a href="../dsl/contexts.html"><strong aria-hidden="true">3.2.</strong> Contexts</a></li><li class="chapter-item expanded "><a href="../dsl/groupby.html" class="active"><strong aria-hidden="true">3.3.</strong> GroupBy</a></li><li class="chapter-item "><a href="../dsl/folds.html"><strong aria-hidden="true">3.4.</strong> Folds</a></li><li class="chapter-item "><a href="../dsl/window_functions.html"><strong aria-hidden="true">3.5.</strong> Window functions</a></li><li class="chapter-item "><a href="../dsl/list_context.html"><strong aria-hidden="true">3.6.</strong> List context and row-wise compute</a></li><li class="chapter-item "><a href="../dsl/numpy.html"><strong aria-hidden="true">3.7.</strong> Numpy universal functions</a></li><li class="chapter-item "><a href="../dsl/custom_functions.html"><strong aria-hidden="true">3.8.</strong> Custom functions</a></li><li class="chapter-item "><a href="../notebooks/introduction_polars-py.html"><strong aria-hidden="true">3.9.</strong> Python Examples</a></li><li class="chapter-item "><a href="../notebooks/introduction_polars-rs.html"><strong aria-hidden="true">3.10.</strong> Rust Examples</a></li><li class="chapter-item "><a href="../dsl/api.html"><strong aria-hidden="true">3.11.</strong> API</a></li><li class="chapter-item "><a href="../dsl/video_intro.html"><strong aria-hidden="true">3.12.</strong> Video introduction</a></li></ol></li><li class="chapter-item expanded "><a href="../lazy-api/intro.html"><strong aria-hidden="true">4.</strong> Lazy API</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../lazy-api/lazy-query-create.html"><strong aria-hidden="true">4.1.</strong> Using the lazy API</a></li><li class="chapter-item "><a href="../lazy-api/lazy-schema.html"><strong aria-hidden="true">4.2.</strong> Schema in the lazy API</a></li><li class="chapter-item "><a href="../lazy-api/lazy-query-plan.html"><strong aria-hidden="true">4.3.</strong> Understanding the query plan</a></li><li class="chapter-item "><a href="../lazy-api/lazy-query-execution.html"><strong aria-hidden="true">4.4.</strong> Executing lazy queries</a></li><li class="chapter-item "><a href="../lazy-api/streaming.html"><strong aria-hidden="true">4.5.</strong> Streaming larger-than-memory datasets</a></li></ol></li><li class="chapter-item expanded "><a href="../datatypes.html"><strong aria-hidden="true">5.</strong> Data Types</a></li><li class="chapter-item expanded "><a href="../coming_from_pandas.html"><strong aria-hidden="true">6.</strong> Coming from Pandas</a></li><li class="chapter-item expanded "><a href="../coming_from_spark.html"><strong aria-hidden="true">7.</strong> Coming from Apache Spark</a></li><li class="chapter-item expanded "><a href="../sql.html"><strong aria-hidden="true">8.</strong> Polars SQL</a></li><li class="chapter-item expanded "><a href="../howcani/intro.html"><strong aria-hidden="true">9.</strong> How can I?</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/io/intro.html"><strong aria-hidden="true">9.1.</strong> IO</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/io/csv.html"><strong aria-hidden="true">9.1.1.</strong> CSV files</a></li><li class="chapter-item "><a href="../howcani/io/parquet.html"><strong aria-hidden="true">9.1.2.</strong> Parquet files</a></li><li class="chapter-item "><a href="../howcani/io/json.html"><strong aria-hidden="true">9.1.3.</strong> JSON files</a></li><li class="chapter-item "><a href="../multiple_files/intro.html"><strong aria-hidden="true">9.1.4.</strong> Multiple files</a></li><li class="chapter-item "><a href="../howcani/io/read_db.html"><strong aria-hidden="true">9.1.5.</strong> Read from a database</a></li><li class="chapter-item "><a href="../howcani/io/aws.html"><strong aria-hidden="true">9.1.6.</strong> Interact with AWS</a></li><li class="chapter-item "><a href="../howcani/io/google-big-query.html"><strong aria-hidden="true">9.1.7.</strong> Interact with Google BigQuery</a></li><li class="chapter-item "><a href="../howcani/io/postgres.html"><strong aria-hidden="true">9.1.8.</strong> Interact with Postgres</a></li><li class="chapter-item "><a href="../howcani/interop/intro.html"><strong aria-hidden="true">9.1.9.</strong> Interoperability</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/interop/arrow.html"><strong aria-hidden="true">9.1.9.1.</strong> Arrow</a></li><li class="chapter-item "><a href="../howcani/interop/numpy.html"><strong aria-hidden="true">9.1.9.2.</strong> NumPy</a></li></ol></li></ol></li><li class="chapter-item "><a href="../howcani/selecting_data/selecting_data_intro.html"><strong aria-hidden="true">9.2.</strong> Selecting data</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/selecting_data/selecting_data_expressions.html"><strong aria-hidden="true">9.2.1.</strong> Selecting with expressions</a></li><li class="chapter-item "><a href="../howcani/selecting_data/selecting_data_indexing.html"><strong aria-hidden="true">9.2.2.</strong> Selecting with indexing</a></li></ol></li><li class="chapter-item "><a href="../howcani/data/intro.html"><strong aria-hidden="true">9.3.</strong> Data handling</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/data/strings.html"><strong aria-hidden="true">9.3.1.</strong> Process strings</a></li><li class="chapter-item "><a href="../howcani/data/timestamps.html"><strong aria-hidden="true">9.3.2.</strong> Process timestamps</a></li><li class="chapter-item "><a href="../howcani/missing_data.html"><strong aria-hidden="true">9.3.3.</strong> Process missing data</a></li></ol></li><li class="chapter-item "><a href="../howcani/timeseries/intro.html"><strong aria-hidden="true">9.4.</strong> Time-series</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/timeseries/parsing_dates_times.html"><strong aria-hidden="true">9.4.1.</strong> Parsing dates and times</a></li><li class="chapter-item "><a href="../howcani/timeseries/selecting_dates.html"><strong aria-hidden="true">9.4.2.</strong> Filtering by dates</a></li><li class="chapter-item "><a href="../howcani/timeseries/temporal_groupby.html"><strong aria-hidden="true">9.4.3.</strong> Fixed and rolling temporal groupby</a></li><li class="chapter-item "><a href="../howcani/timeseries/resampling.html"><strong aria-hidden="true">9.4.4.</strong> Resampling</a></li><li class="chapter-item "><a href="../howcani/timeseries/time_zones.html"><strong aria-hidden="true">9.4.5.</strong> Time zones</a></li></ol></li><li class="chapter-item "><a href="../howcani/combining_data/intro.html"><strong aria-hidden="true">9.5.</strong> Combining data</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../howcani/combining_data/concatenating.html"><strong aria-hidden="true">9.5.1.</strong> Concatenation</a></li><li class="chapter-item "><a href="../howcani/combining_data/joining.html"><strong aria-hidden="true">9.5.2.</strong> Joining</a></li></ol></li><li class="chapter-item "><a href="../howcani/multiprocessing.html"><strong aria-hidden="true">9.6.</strong> Multiprocessing</a></li></ol></li><li class="chapter-item expanded "><a href="../performance/intro.html"><strong aria-hidden="true">10.</strong> Performance</a><a class="toggle"><div>â±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="../performance/strings.html"><strong aria-hidden="true">10.1.</strong> Strings</a></li></ol></li><li class="chapter-item expanded "><a href="../optimizations/intro.html"><strong aria-hidden="true">11.</strong> Optimizations</a></li><li class="chapter-item expanded "><a href="../testing/schema.html"><strong aria-hidden="true">12.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../references.html"><strong aria-hidden="true">13.</strong> Reference guides</a></li><li class="chapter-item expanded "><a href="../contributing.html"><strong aria-hidden="true">14.</strong> Contributing</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu (default)</button></li>
                        </ul>
                        
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                        
                    </div>

                    <h1 class="menu-title">Polars - User Guide</h1>

                    <div class="right-buttons">
                        
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        
                        
                    </div>
                </div>

                
                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" name="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="groupby"><a class="header" href="#groupby">GroupBy</a></h1>
<blockquote>
<p>The GroupBy page is under construction.</p>
</blockquote>
<h2 id="a-multithreaded-approach"><a class="header" href="#a-multithreaded-approach">A multithreaded approach</a></h2>
<p>One of the most efficient ways to process tabular data is to parallelize its processing
via the &quot;split-apply-combine&quot; approach. This operation is at the core of the <code>Polars</code>
grouping implementation, allowing it to attain lightning-fast operations. Specifically, both the &quot;split&quot; and &quot;apply&quot; phases are executed in a multi-threaded
fashion.</p>
<p>A simple grouping operation is taken below as an example to illustrate this approach:</p>
<p><img src="https://raw.githubusercontent.com/pola-rs/polars-static/master/docs/split-apply-combine.svg" alt="" /></p>
<p>For the hashing operations performed during the &quot;split&quot; phase, <code>Polars</code> uses a
multithreaded lock-free approach that is illustrated on the following schema:</p>
<p><img src="https://raw.githubusercontent.com/pola-rs/polars-static/master/docs/lock-free-hash.svg" alt="" /></p>
<p>This parallelization allows the grouping and joining operations (for instance) to be
blazingly fast!</p>
<blockquote>
<p>Check out <a href="https://www.ritchievink.com/blog/2021/02/28/i-wrote-one-of-the-fastest-dataframe-libraries/">this blog post</a>
for more details.</p>
</blockquote>
<h2 id="do-not-kill-the-parallelization"><a class="header" href="#do-not-kill-the-parallelization">Do not kill the parallelization!</a></h2>
<blockquote>
<p>The following is specific to <code>Python</code>, and doesn't apply to <code>Rust</code>.  Within <code>Rust</code>, blocks and closures (<em>lambdas</em>) can, and will, be executed concurrently.</p>
</blockquote>
<p>We have all heard that <code>Python</code> is slow, and does &quot;not scale.&quot; Besides the overhead of
running &quot;slow&quot; bytecode, <code>Python</code> has to remain within the constraints of the Global
Interpreter Lock (GIL). This means that if you were to use a <code>lambda</code> or a custom <code>Python</code>
function to apply during a parallelized phase, <code>Polars</code> speed is capped running <code>Python</code>
code preventing any multiple threads from executing the function.</p>
<p>This all feels terribly limiting, especially because we often need those <code>lambda</code> functions in a
<code>.groupby()</code> step, for example. This approach is still supported by <code>Polars</code>, but
keeping in mind bytecode <strong>and</strong> the GIL costs have to be paid.</p>
<p>To mitigate this, <code>Polars</code> implements a powerful syntax defined not only in its lazy API,
but also in its eager API.  Let's take a look at what that means.</p>
<p>We can start with the simple
<a href="https://github.com/unitedstates/congress-legislators">US congress <code>dataset</code></a>.</p>
<blockquote>
<p>Note to Rust users, the <code>dtype-categorical</code> feature must be enabled for the examples in this section.</p>
</blockquote>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

url = &quot;https://theunitedstates.io/congress-legislators/legislators-historical.csv&quot;

dtypes = {
    &quot;first_name&quot;: pl.Categorical,
    &quot;gender&quot;: pl.Categorical,
    &quot;type&quot;: pl.Categorical,
    &quot;state&quot;: pl.Categorical,
    &quot;party&quot;: pl.Categorical,
}

dataset = pl.read_csv(url, dtypes=dtypes).with_columns(pl.col(&quot;birthday&quot;).str.strptime(pl.Date, strict=False))
</code></pre>
<pre><code class="language-rust noplayground">    let url = &quot;https://theunitedstates.io/congress-legislators/legislators-historical.csv&quot;;

    let mut schema = Schema::new();
    schema.with_columns(&quot;first_name&quot;.to_string(), DataType::Categorical(None));
    schema.with_columns(&quot;gender&quot;.to_string(), DataType::Categorical(None));
    schema.with_columns(&quot;type&quot;.to_string(), DataType::Categorical(None));
    schema.with_columns(&quot;state&quot;.to_string(), DataType::Categorical(None));
    schema.with_columns(&quot;party&quot;.to_string(), DataType::Categorical(None));
    schema.with_columns(&quot;birthday&quot;.to_string(), DataType::Date);

    let data: Vec&lt;u8&gt; = Client::new().get(url).send()?.text()?.bytes().collect();

    let dataset = CsvReader::new(Cursor::new(data))
        .has_header(true)
        .with_dtypes(Some(&amp;schema))
        .with_parse_dates(true)
        .finish()?;

    println!(&quot;{}&quot;, &amp;dataset);
</code></pre>
</div>
<h4 id="basic-aggregations"><a class="header" href="#basic-aggregations">Basic aggregations</a></h4>
<p>You can easily combine different aggregations by adding multiple expressions in a
<code>list</code>. There is no upper bound on the number of aggregations you can do, and you can
make any combination you want. In the snippet below we do the following aggregations:</p>
<p>Per GROUP <code>&quot;first_name&quot;</code> we</p>
<ul>
<li>count the number of rows in the group:
<ul>
<li>short form: <code>pl.count(&quot;party&quot;)</code></li>
<li>full form: <code>pl.col(&quot;party&quot;).count()</code></li>
</ul>
</li>
<li>aggregate the gender values groups:
<ul>
<li>full form: <code>pl.col(&quot;gender&quot;)</code></li>
</ul>
</li>
<li>get the first value of column <code>&quot;last_name&quot;</code> in the group:
<ul>
<li>short form: <code>pl.first(&quot;last_name&quot;)</code> (not available in Rust)</li>
<li>full form: <code>pl.col(&quot;last_name&quot;).first()</code></li>
</ul>
</li>
</ul>
<p>Besides the aggregation, we immediately sort the result and limit to the top <code>5</code> so that
we have a nice summary overview.</p>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

from .dataset import dataset

q = (
    dataset.lazy()
    .groupby(&quot;first_name&quot;)
    .agg(
        [
            pl.count(),
            pl.col(&quot;gender&quot;),
            pl.first(&quot;last_name&quot;),
        ]
    )
    .sort(&quot;count&quot;, descending=True)
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    let df = dataset
        .clone()
        .lazy()
        .groupby([&quot;first_name&quot;])
        .agg([count(), col(&quot;gender&quot;).list(), col(&quot;last_name&quot;).first()])
        .sort(
            &quot;count&quot;,
            SortOptions {
                descending: true,
                nulls_last: true,
            },
        )
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ first_name â”† count â”† gender            â”† last_name â”‚
â”‚ ---        â”† ---   â”† ---               â”† ---       â”‚
â”‚ cat        â”† u32   â”† list[cat]         â”† str       â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ John       â”† 1256  â”† [&quot;M&quot;, &quot;M&quot;, â€¦ &quot;M&quot;] â”† Walker    â”‚
â”‚ William    â”† 1022  â”† [&quot;M&quot;, &quot;M&quot;, â€¦ &quot;M&quot;] â”† Few       â”‚
â”‚ James      â”† 714   â”† [&quot;M&quot;, &quot;M&quot;, â€¦ &quot;M&quot;] â”† Armstrong â”‚
â”‚ Thomas     â”† 454   â”† [&quot;M&quot;, &quot;M&quot;, â€¦ &quot;M&quot;] â”† Tucker    â”‚
â”‚ Charles    â”† 439   â”† [&quot;M&quot;, &quot;M&quot;, â€¦ &quot;M&quot;] â”† Carroll   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="conditionals"><a class="header" href="#conditionals">Conditionals</a></h4>
<p>It's that easy! Let's turn it up a notch. Let's say we want to know how
many delegates of a &quot;state&quot; are &quot;Pro&quot; or &quot;Anti&quot; administration. We could directly query
that in the aggregation without the need of <code>lambda</code> or grooming the <code>DataFrame</code>.</p>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

from .dataset import dataset

q = (
    dataset.lazy()
    .groupby(&quot;state&quot;)
    .agg(
        [
            (pl.col(&quot;party&quot;) == &quot;Anti-Administration&quot;).sum().alias(&quot;anti&quot;),
            (pl.col(&quot;party&quot;) == &quot;Pro-Administration&quot;).sum().alias(&quot;pro&quot;),
        ]
    )
    .sort(&quot;pro&quot;, descending=True)
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    let df = dataset
        .clone()
        .lazy()
        .groupby([&quot;state&quot;])
        .agg([
            (col(&quot;party&quot;).eq(lit(&quot;Anti-Administration&quot;)))
                .sum()
                .alias(&quot;anti&quot;),
            (col(&quot;party&quot;).eq(lit(&quot;Pro-Administration&quot;)))
                .sum()
                .alias(&quot;pro&quot;),
        ])
        .sort(
            &quot;pro&quot;,
            SortOptions {
                descending: true,
                nulls_last: false,
            },
        )
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 3)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”
â”‚ state â”† anti â”† pro â”‚
â”‚ ---   â”† ---  â”† --- â”‚
â”‚ cat   â”† u32  â”† u32 â”‚
â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•ªâ•â•â•â•â•â•¡
â”‚ CT    â”† 0    â”† 3   â”‚
â”‚ NJ    â”† 0    â”† 3   â”‚
â”‚ NC    â”† 1    â”† 2   â”‚
â”‚ SC    â”† 0    â”† 1   â”‚
â”‚ PA    â”† 1    â”† 1   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”˜
</code></pre>
<p>Similarly,  this could also be done with a nested GROUPBY, but that doesn't help show off some of these nice features. ğŸ˜‰</p>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

from .dataset import dataset

q = (
    dataset.lazy()
    .groupby([&quot;state&quot;, &quot;party&quot;])
    .agg([pl.count(&quot;party&quot;).alias(&quot;count&quot;)])
    .filter((pl.col(&quot;party&quot;) == &quot;Anti-Administration&quot;) | (pl.col(&quot;party&quot;) == &quot;Pro-Administration&quot;))
    .sort(&quot;count&quot;, descending=True)
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    let df = dataset
        .clone()
        .lazy()
        .groupby([&quot;state&quot;, &quot;party&quot;])
        .agg([col(&quot;party&quot;).count().alias(&quot;count&quot;)])
        .filter(
            col(&quot;party&quot;)
                .eq(lit(&quot;Anti-Administration&quot;))
                .or(col(&quot;party&quot;).eq(lit(&quot;Pro-Administration&quot;))),
        )
        .sort(
            &quot;count&quot;,
            SortOptions {
                descending: true,
                nulls_last: true,
            },
        )
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 3)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”
â”‚ state â”† party               â”† count â”‚
â”‚ ---   â”† ---                 â”† ---   â”‚
â”‚ cat   â”† cat                 â”† u32   â”‚
â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•¡
â”‚ CT    â”† Pro-Administration  â”† 3     â”‚
â”‚ NJ    â”† Pro-Administration  â”† 3     â”‚
â”‚ VA    â”† Anti-Administration â”† 3     â”‚
â”‚ NC    â”† Pro-Administration  â”† 2     â”‚
â”‚ SC    â”† Pro-Administration  â”† 1     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="filtering"><a class="header" href="#filtering">Filtering</a></h4>
<p>We can also filter the groups. Let's say we want to compute a mean per group, but we
don't want to include all values from that group, and we also don't want to filter the
rows from the <code>DataFrame</code> (because we need those rows for another aggregation).</p>
<p>In the example below we show how that can be done.</p>
<blockquote>
<p>Note that we can make <code>Python</code> functions for clarity. These functions don't cost us anything. That is because we only create <code>Polars</code> expressions, we don't apply a custom function over a <code>Series</code> during runtime of the query.  Of course, you can make functions that return expressions in Rust, too.</p>
</blockquote>
<div class="tabbed-blocks">
<pre><code class="language-python">from datetime import date

import polars as pl

from .dataset import dataset


def compute_age() -&gt; pl.Expr:
    return date(2021, 1, 1).year - pl.col(&quot;birthday&quot;).dt.year()


def avg_birthday(gender: str) -&gt; pl.Expr:
    return compute_age().filter(pl.col(&quot;gender&quot;) == gender).mean().alias(f&quot;avg {gender} birthday&quot;)


q = (
    dataset.lazy()
    .groupby([&quot;state&quot;])
    .agg(
        [
            avg_birthday(&quot;M&quot;),
            avg_birthday(&quot;F&quot;),
            (pl.col(&quot;gender&quot;) == &quot;M&quot;).sum().alias(&quot;# male&quot;),
            (pl.col(&quot;gender&quot;) == &quot;F&quot;).sum().alias(&quot;# female&quot;),
        ]
    )
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    fn compute_age() -&gt; Expr {
        lit(2022) - col(&quot;birthday&quot;).dt().year()
    }

    fn avg_birthday(gender: &amp;str) -&gt; Expr {
        compute_age()
            .filter(col(&quot;gender&quot;).eq(lit(gender)))
            .mean()
            .alias(&amp;format!(&quot;avg {} birthday&quot;, gender))
    }

    let df = dataset
        .clone()
        .lazy()
        .groupby([&quot;state&quot;])
        .agg([
            avg_birthday(&quot;M&quot;),
            avg_birthday(&quot;F&quot;),
            (col(&quot;gender&quot;).eq(lit(&quot;M&quot;))).sum().alias(&quot;# male&quot;),
            (col(&quot;gender&quot;).eq(lit(&quot;F&quot;))).sum().alias(&quot;# female&quot;),
        ])
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 5)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ state â”† avg M birthday â”† avg F birthday â”† # male â”† # female â”‚
â”‚ ---   â”† ---            â”† ---            â”† ---    â”† ---      â”‚
â”‚ cat   â”† f64            â”† f64            â”† u32    â”† u32      â”‚
â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•¡
â”‚ AL    â”† 163.772727     â”† 97.5           â”† 207    â”† 4        â”‚
â”‚ IL    â”† 153.710638     â”† 97.4           â”† 478    â”† 15       â”‚
â”‚ AZ    â”† 114.586957     â”† 76.8           â”† 46     â”† 5        â”‚
â”‚ PI    â”† 145.0          â”† null           â”† 13     â”† 0        â”‚
â”‚ OK    â”† 119.934066     â”† 93.0           â”† 91     â”† 3        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h4 id="sorting"><a class="header" href="#sorting">Sorting</a></h4>
<p>It's common to see a <code>DataFrame</code> being sorted for the sole purpose of managing the ordering during a GROUPBY operation. Let's say that we want to get the names of the oldest and youngest politicians per state. We could SORT and GROUPBY.</p>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

from .dataset import dataset


def get_person() -&gt; pl.Expr:
    return pl.col(&quot;first_name&quot;) + pl.lit(&quot; &quot;) + pl.col(&quot;last_name&quot;)


q = (
    dataset.lazy()
    .sort(&quot;birthday&quot;, descending=True)
    .groupby([&quot;state&quot;])
    .agg(
        [
            get_person().first().alias(&quot;youngest&quot;),
            get_person().last().alias(&quot;oldest&quot;),
        ]
    )
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    fn get_person() -&gt; Expr {
        col(&quot;first_name&quot;) + lit(&quot; &quot;) + col(&quot;last_name&quot;)
    }

    let df = dataset
        .clone()
        .lazy()
        .sort(
            &quot;birthday&quot;,
            SortOptions {
                descending: true,
                nulls_last: true,
            },
        )
        .groupby([&quot;state&quot;])
        .agg([
            get_person().first().alias(&quot;youngest&quot;),
            get_person().last().alias(&quot;oldest&quot;),
        ])
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 3)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ state â”† youngest         â”† oldest          â”‚
â”‚ ---   â”† ---              â”† ---             â”‚
â”‚ cat   â”† str              â”† str             â”‚
â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ MO    â”† Vicky Hartzler   â”† Spencer Pettis  â”‚
â”‚ NH    â”† Frank Guinta     â”† John Sherburne  â”‚
â”‚ NE    â”† Benjamin Sasse   â”† Samuel Daily    â”‚
â”‚ NC    â”† Madison Cawthorn â”† John Ashe       â”‚
â”‚ ID    â”† RaÃºl Labrador    â”† William Wallace â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p>However, <strong>if</strong> we also want to sort the names alphabetically, this breaks. Luckily we can sort in a <code>groupby</code> context separate from the <code>DataFrame</code>.</p>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

from .dataset import dataset


def get_person() -&gt; pl.Expr:
    return pl.col(&quot;first_name&quot;) + pl.lit(&quot; &quot;) + pl.col(&quot;last_name&quot;)


q = (
    dataset.lazy()
    .sort(&quot;birthday&quot;, descending=True)
    .groupby([&quot;state&quot;])
    .agg(
        [
            get_person().first().alias(&quot;youngest&quot;),
            get_person().last().alias(&quot;oldest&quot;),
            get_person().sort().first().alias(&quot;alphabetical_first&quot;),
        ]
    )
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    let df = dataset
        .clone()
        .lazy()
        .sort(
            &quot;birthday&quot;,
            SortOptions {
                descending: true,
                nulls_last: true,
            },
        )
        .groupby([&quot;state&quot;])
        .agg([
            get_person().first().alias(&quot;youngest&quot;),
            get_person().last().alias(&quot;oldest&quot;),
            get_person().sort(false).first().alias(&quot;alphabetical_first&quot;),
        ])
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ state â”† youngest       â”† oldest           â”† alphabetical_first â”‚
â”‚ ---   â”† ---            â”† ---              â”† ---                â”‚
â”‚ cat   â”† str            â”† str              â”† str                â”‚
â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ CT    â”† Elizabeth Esty â”† Henry Edwards    â”† Abner Sibal        â”‚
â”‚ VT    â”† Peter Smith    â”† Samuel Shaw      â”† Ahiman Miner       â”‚
â”‚ WI    â”† Sean Duffy     â”† Henry Dodge      â”† Adolphus Nelson    â”‚
â”‚ ID    â”† RaÃºl Labrador  â”† William Wallace  â”† Abe Goff           â”‚
â”‚ WV    â”† Carte Goodwin  â”† Edward Rohrbough â”† Adam Littlepage    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<p>We can even sort by another column in the <code>groupby</code> context. If we want to know if the alphabetically sorted name is male or female we could add: <code>pl.col(&quot;gender&quot;).sort_by(&quot;first_name&quot;).first().alias(&quot;gender&quot;)</code></p>
<div class="tabbed-blocks">
<pre><code class="language-python">import polars as pl

from .dataset import dataset


def get_person() -&gt; pl.Expr:
    return pl.col(&quot;first_name&quot;) + pl.lit(&quot; &quot;) + pl.col(&quot;last_name&quot;)


q = (
    dataset.lazy()
    .sort(&quot;birthday&quot;, descending=True)
    .groupby([&quot;state&quot;])
    .agg(
        [
            get_person().first().alias(&quot;youngest&quot;),
            get_person().last().alias(&quot;oldest&quot;),
            get_person().sort().first().alias(&quot;alphabetical_first&quot;),
            pl.col(&quot;gender&quot;).sort_by(&quot;first_name&quot;).first().alias(&quot;gender&quot;),
        ]
    )
    .sort(&quot;state&quot;)
    .limit(5)
)

df = q.collect()
</code></pre>
<pre><code class="language-rust noplayground">    let df = dataset
        .clone()
        .lazy()
        .sort(
            &quot;birthday&quot;,
            SortOptions {
                descending: true,
                nulls_last: true,
            },
        )
        .groupby([&quot;state&quot;])
        .agg([
            get_person().first().alias(&quot;youngest&quot;),
            get_person().last().alias(&quot;oldest&quot;),
            get_person().sort(false).first().alias(&quot;alphabetical_first&quot;),
            col(&quot;gender&quot;)
                .sort_by([&quot;first_name&quot;], [false])
                .first()
                .alias(&quot;gender&quot;),
        ])
        .sort(&quot;state&quot;, SortOptions::default())
        .limit(5)
        .collect()?;

    println!(&quot;{}&quot;, df);
</code></pre>
</div>
<pre><code class="language-text">shape: (5, 5)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ state â”† youngest         â”† oldest            â”† alphabetical_first â”† gender â”‚
â”‚ ---   â”† ---              â”† ---               â”† ---                â”† ---    â”‚
â”‚ cat   â”† str              â”† str               â”† str                â”† cat    â”‚
â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•¡
â”‚ PA    â”† Conor Lamb       â”† Thomas Fitzsimons â”† Aaron Kreider      â”† M      â”‚
â”‚ KY    â”† Ben Chandler     â”† John Edwards      â”† Aaron Harding      â”† M      â”‚
â”‚ MD    â”† Frank Kratovil   â”† Benjamin Contee   â”† Albert Blakeney    â”† M      â”‚
â”‚ OH    â”† Anthony Gonzalez â”† John Smith        â”† Aaron Harlan       â”† M      â”‚
â”‚ VA    â”† Scott Taylor     â”† William Grayson   â”† A. McEachin        â”† M      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre>
<h3 id="conclusion"><a class="header" href="#conclusion">Conclusion</a></h3>
<p>In the examples above we've seen that we can do a lot by combining expressions. By doing so we delay the use of custom <code>Python</code> functions that slow down the queries (by the slow nature of Python AND the GIL).</p>
<p>If we are missing a type expression let us know by opening a
<a href="https://github.com/pola-rs/polars/issues/new/choose">feature request</a>!</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="../dsl/contexts.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="../dsl/folds.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a rel="prev" href="../dsl/contexts.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="../dsl/folds.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>

        

        

        

        
        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        

        

        
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        

        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        <script type="text/javascript" src="../tabbed-code-blocks.js"></script>
        

        

    </body>
</html>
